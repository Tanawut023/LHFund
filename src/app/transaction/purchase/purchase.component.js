"use strict";var __decorate=this&&this.__decorate||function(e,t,o,s){var r,i=arguments.length,n=i<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,o):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,o,s);else for(var a=e.length-1;0<=a;a--)(r=e[a])&&(n=(i<3?r(n):3<i?r(t,o,n):r(t,o))||n);return 3<i&&n&&Object.defineProperty(t,o,n),n};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),operators_1=require("rxjs/operators"),http_1=require("@angular/common/http"),dateformat_1=require("../../Share/dateformat"),forms_1=require("@angular/forms"),customValidationService=function(){function e(){}return e.checkLimit=function(o,s){return function(e){console.log(e.value);var t=e.value;return t&&(t=t.replace(",",""),t=parseFloat(t)),0==t?(console.log("Is 0"),{invalid:!0}):t&&(isNaN(t)||t<o||s<t||0==t)?{invalid:!0}:null}},e}();exports.customValidationService=customValidationService;var PurchaseComponent=function(){function e(e,t,o,s){this.translate=e,this.basedataservice=t,this.orderservice=o,this.fb=s,this.page="purchase",this.dialog=!1,this.content="ท่านยังไม่ได้ทำแบบประเมินความเสี่ยงหรือเคยทำมาแล้วเกิน2ปี หากต้องการดำเนินการต่อกรุณากด ตกลง",this.userall={},this.userselect={},this.unitholderno="N/A",this.unitholdersubscription={},this.fundlist="",this.banklist="N/A",this.currentdate=dateformat_1.datethai,this.isNotValid=!1,this.nolist=!1,this.Islevel=!1,this.Isprotect=!1,e.addLangs(["th","en"])}return Object.defineProperty(e.prototype,"cpwd",{get:function(){return this.formsubsription.get("amount")},enumerable:!0,configurable:!0}),e.prototype.ngOnInit=function(){this.getSelectListUnitholder(),$("#mutual-tab-menu").find("li").removeClass("current"),$("#mutual-tab-menu").find("li#menu1").addClass("current");var e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate()+1);console.log(t),this.minDate={year:t.getFullYear(),month:t.getMonth()+1,day:t.getDate()},this.datepick={year:e.getFullYear(),month:e.getMonth()+1,day:e.getDate()},this.createFormValidate(),this._originalData=this.formsubsription.value},e.prototype.ngAfterViewInit=function(){},e.prototype.checkpage=function(e){switch(window.scroll(0,0),console.log(e),e){case"purchase":this.dialog=!1,this.page="purchase",this.getorderinfolist(),this.reset();break;case"purchase-step1":this.formsubsription.controls.date.value&&(this.date=this.formsubsription.controls.date.value.year+"-"+this.formsubsription.controls.date.value.month+"-"+this.formsubsription.controls.date.value.day,this.date=dateformat_1.formatdatethai(this.date)),this.resultsubmit.messages[0]&&(this.message=this.resultsubmit.messages[0],setTimeout(function(){$("#message").modal({backdrop:"static",keyboard:!1,show:!0})},100)),this.page="purchase-step1";break;case"purchase-step2":this.page="purchase-step2";break;case"purchase-view-list":this.page="purchase-view-list";break;default:this.page="purchase",console.log(this.page)}},e.prototype.onChange=function(){for(var e=0;e<this.userall.unitholderlist.length;e++)this.userall.unitholderlist[e].UnitholderId==this.unitholderno.UnitholderId&&(this.userselect=this.userall.unitholderlist[e],this.getselectlistfundlistandbankaccount())},e.prototype.getSelectListUnitholder=function(){var t=this;this.basedataservice.getSelectListUnitholder().pipe(operators_1.first()).subscribe(function(e){console.log(e),e&&(t.userall=e,t.unitholderno=t.userall.unitholderlist[0],t.userselect=t.userall.unitholderlist[0],t.getselectlistfundlistandbankaccount(),t.getorderinfolist())},function(e){console.log(e)})},e.prototype.getselectlistfundlistandbankaccount=function(){var t=this,e=(new http_1.HttpParams).set("unitholderid",this.userselect.UnitholderId);this.orderservice.changeunitholdersubscription(e).pipe(operators_1.first()).subscribe(function(e){e&&(console.log(e),t.unitholdersubscription=e,t.unitholdersubscription.bankaccountlist[0]&&(t.banklist=t.unitholdersubscription.bankaccountlist[0]))},function(e){console.log(e)})},e.prototype.createFormValidate=function(){this.formsubsription=this.fb.group({fund:["",[forms_1.Validators.required]],amount:[null,[forms_1.Validators.required]],date:[null]})},e.prototype.validateAllFormFields=function(o){var s=this;Object.keys(o.controls).forEach(function(e){var t=o.get(e);t instanceof forms_1.FormControl?t.markAsTouched({onlySelf:!0}):t instanceof forms_1.FormGroup&&s.validateAllFormFields(t)})},e.prototype.tofix=function(e){if(console.log(e),e){var t=e;t=t.replace(",","");var o=parseFloat(t).toFixed(2);o=o.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),console.log(o),this.formsubsription.controls.amount.setValue(o,{onlySelf:!0})}},e.prototype.onSubmited=function(){var t=this;if(console.log(this.formsubsription),this.Islevel=!1,this.Isprotect=!1,this.formsubsription.valid)if(1==this.userselect.RiskLevelExpire)console.log("expire"),$("#expiremodal").modal({backdrop:"static",keyboard:!1,show:!0});else if(this.unitholdersubscription.bankaccountlist[0]){var e;this.isNotValid=!1,this.formsubsription.controls.date.value?(this.date=this.formsubsription.controls.date.value.year+"-"+this.formsubsription.controls.date.value.month+"-"+this.formsubsription.controls.date.value.day,this.date=dateformat_1.boostrapdatepicker(this.date),e={UnitHolderID:this.userselect.UnitholderId,FundID:this.formsubsription.controls.fund.value.FundID,CounterFundID:0,TxType:"Subscription",OrderUnitType:"Amount",OrderUnit:0,OrderBankAccountID:this.banklist.BankAccountID,OrderAmount:this.formsubsription.controls.amount.value,PaymentMethod:"ATS",orderdate:this.date}):e={UnitHolderID:this.userselect.UnitholderId,FundID:this.formsubsription.controls.fund.value.FundID,CounterFundID:0,TxType:"Subscription",OrderUnitType:"Amount",OrderUnit:0,OrderBankAccountID:this.banklist.BankAccountID,OrderAmount:this.formsubsription.controls.amount.value,PaymentMethod:"ATS",orderdate:null},console.log(e),this.orderservice.submitorder(e).pipe(operators_1.first()).subscribe(function(e){console.log(e),t.resultsubmit=e,t.checkexpireandlevel()},function(e){console.log(e),t.message=e.error.messages,$("#message").modal({backdrop:"static",keyboard:!1,show:!0})})}else this.message="ติดต่อเจ้าหน้าที่การตลาด เบอร์ติดต่อ 02-286-3484 หรือ 02-679-2155 เพื่อดำเนินขอเปิดบัญชี ATS",setTimeout(function(){$("#message").modal({backdrop:"static",keyboard:!1,show:!0})},100);else this.isNotValid=!0,this.validateAllFormFields(this.formsubsription)},e.prototype.checkexpireandlevel=function(){var t=this,e={UnitHolderID:this.userselect.UnitholderId,FundID:this.formsubsription.controls.fund.value.FundID};console.log(e),this.orderservice.changefundsubscription(e).pipe(operators_1.first()).subscribe(function(e){console.log(e),e.messages&&(t.message=e.messages,t.Islevel=!0)},function(e){console.log(e),t.message=e.error.messages,$("#message").modal({backdrop:"static",keyboard:!1,show:!0})}),setTimeout(function(){t.Islevel&&(console.log("level"),$("#risklevel").modal({backdrop:"static",keyboard:!1,show:!0})),"N"==t.formsubsription.controls.fund.value.isFullyHedge&&(console.log("level+protect"),t.Isprotect=!0,$("#risklevel").modal({backdrop:"static",keyboard:!1,show:!0})),"N"===t.formsubsription.controls.fund.value.isFullyHedge||t.Islevel||(console.log("nothing"),t.checkpage("purchase-step1"))},100)},e.prototype.confirmsubscription=function(){var t=this;this.orderservice.confirmorder(this.resultsubmit.data).pipe(operators_1.first()).subscribe(function(e){console.log(e),t.page="purchase-step2"},function(e){console.log(e),t.message=e.error.messages,$("#message").modal({backdrop:"static",keyboard:!1,show:!0})})},e.prototype.isFieldNotValid=function(e){return!this.formsubsription.get(e).valid&&this.formsubsription.get(e).touched},e.prototype.ValidatorDisplayCss=function(e){return{"has-danger":this.isFieldNotValid(e)}},e.prototype.numberOnly=function(e){var t=e.which?e.which:e.keyCode;return console.log(t),!(31<t&&(t<48||57<t)&&46!==t)},e.prototype.getorderinfolist=function(){var o=this,e={UnitHolderID:this.userselect.UnitholderId,TxType:"Subscription"};this.orderservice.getorderinfolist(e).pipe(operators_1.first()).subscribe(function(e){if(console.log(e),o.ordersubscriptionlist=e,o.nolist=!1,o.ordersubscriptionlist.orderinfolist)for(var t=0;t<o.ordersubscriptionlist.orderinfolist.length;t++)"Initial"==o.ordersubscriptionlist.orderinfolist[t].OrderStatus&&"Subscription"==o.ordersubscriptionlist.orderinfolist[t].TxType&&(o.nolist=!0,console.log("nolist"))},function(e){console.log(e),o.message=e.error.messages,$("#message").modal({backdrop:"static",keyboard:!1,show:!0})})},e.prototype.reset=function(){console.log("reset"),this.createFormValidate(),this.getselectlistfundlistandbankaccount()},e.prototype.resetdate=function(){this.formsubsription.controls.date.reset()},e.prototype.modaldeleteorder=function(e){this.deletedOrder=e,console.log(this.deletedOrder),$("#delete").modal({backdrop:"static",keyboard:!1,show:!0})},e.prototype.deleteorder=function(){var t=this,e={UnitHolderID:this.deletedOrder.UnitHolderID,OrderID:this.deletedOrder.OrderID};this.orderservice.cancelorder(e).pipe(operators_1.first()).subscribe(function(e){console.log(e),t.getorderinfolist(),$("#delete").modal("toggle")},function(e){console.log(e),$("#delete").modal("toggle"),t.message=e.error.messages,$("#message").modal({backdrop:"static",keyboard:!1,show:!0})})},e.prototype.isDisabled=function(e){var t=new Date(e.year,e.month-1,e.day);return 0===t.getDay()||6===t.getDay()},e.prototype.print=function(){window.focus(),window.print()},e=__decorate([core_1.Component({selector:"app-purchase",templateUrl:"./purchase.component.html",styleUrls:["./purchase.component.scss"]})],e)}();exports.PurchaseComponent=PurchaseComponent;