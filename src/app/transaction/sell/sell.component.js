"use strict";var __decorate=this&&this.__decorate||function(e,t,o,r){var i,n=arguments.length,l=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,o,r);else for(var s=e.length-1;0<=s;s--)(i=e[s])&&(l=(n<3?i(l):3<n?i(t,o,l):i(t,o))||l);return 3<n&&l&&Object.defineProperty(t,o,l),l};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),operators_1=require("rxjs/operators"),dateformat_1=require("../../Share/dateformat"),http_1=require("@angular/common/http"),forms_1=require("@angular/forms"),SellComponent=function(){function e(e,t,o,r){this.translate=e,this.basedataservice=t,this.orderservice=o,this.fb=r,this.page="sell",this.userall={},this.userselect={},this.unitholderno="N/A",this.currentdate=dateformat_1.datethai,this.unitholderredemption={},this.fundlist="N/A",this.banklist="N/A",this.holdingbalancelist="N/A",this.amount=3,this.Type="",this.nolist=!1,this.loading=!1}return e.prototype.ngOnInit=function(){this.getSelectListUnitholder(),this.createFormValidate(),this._originalData=this.formredemption.value,$("#mutual-tab-menu").find("li").removeClass("current"),$("#mutual-tab-menu").find("li#menu2").addClass("current");var e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate()+1);console.log(t),this.minDate={year:t.getFullYear(),month:t.getMonth()+1,day:t.getDate()},this.datepick={year:e.getFullYear(),month:e.getMonth()+1,day:e.getDate()}},e.prototype.checkpage=function(e){switch(window.scroll(0,0),console.log(e),e){case"sell":this.page="sell",this.getorderinfolist(),this.reset();break;case"sell-step1":""!=this.resultvalidate.messages[0]&&$("#warning-ltfrmf").modal("toggle"),this.formredemption.controls.date.value&&(this.date=this.formredemption.controls.date.value.year+"-"+this.formredemption.controls.date.value.month+"-"+this.formredemption.controls.date.value.day,this.date=dateformat_1.formatdatethai(this.date)),this.page="sell-step1",this.resultsubmit.messages[0]&&(this.message=this.resultsubmit.messages[0],setTimeout(function(){$("#message").modal({backdrop:"static",keyboard:!1,show:!0})},100));break;case"sell-step2":this.page="sell-step2",this.fundlistonChange();break;case"sell-view-list":this.page="sell-view-list";break;default:this.page="sell",console.log(this.page)}},e.prototype.onChange=function(){for(var e=0;e<this.userall.unitholderlist.length;e++)this.userall.unitholderlist[e].UnitholderId==this.unitholderno.UnitholderId&&(this.userselect=this.userall.unitholderlist[e],this.getselectlistfundlistandbankaccount(),this.getorderinfolist())},e.prototype.getSelectListUnitholder=function(){var t=this;this.basedataservice.getSelectListUnitholder().pipe(operators_1.first()).subscribe(function(e){console.log(e),setTimeout(function(){$(".selectpicker").selectpicker("refresh")},100),e&&(t.userall=e,t.unitholderno=t.userall.unitholderlist[0],t.userselect=t.userall.unitholderlist[0],t.getselectlistfundlistandbankaccount(),t.getorderinfolist())},function(e){console.log(e)})},e.prototype.getselectlistfundlistandbankaccount=function(){var t=this,e=(new http_1.HttpParams).set("unitholderid",this.userselect.UnitholderId);this.orderservice.changeunitholderredemption(e).pipe(operators_1.first()).subscribe(function(e){console.log(e),setTimeout(function(){$(".selectpicker").selectpicker("refresh")},100),e&&(t.unitholderredemption=e,t.unitholderredemption.fundlist&&(t.fundlist=t.unitholderredemption.fundlist[0]),t.unitholderredemption.bankaccountlist?t.banklist=t.unitholderredemption.bankaccountlist[0]:0==t.unitholderredemption.bankaccountlist.length&&(t.banklist=""),t.unitholderredemption.holdingbalance&&(t.holdingbalancelist=t.unitholderredemption.holdingbalance[0]))},function(e){console.log(e)})},e.prototype.fundlistonChange=function(){var t=this,e={UnitHolderID:this.userselect.UnitholderId,FundID:this.formredemption.controls.fund.value.FundID};this.orderservice.changefundredemption(e).pipe(operators_1.first()).subscribe(function(e){console.log(e),t.holdingbalanceselected=e,"sell-step2"!==t.page&&(t.Type="",t.formredemption.controls.amount.setValue("",{onlySelf:!0}),t.formredemption.controls.type.setValue("",{onlySelf:!0}))},function(e){console.log(e),t.message=e.error.messages,$("#message").modal({backdrop:"static",keyboard:!1,show:!0})})},e.prototype.getorderinfolist=function(){var o=this,e={UnitHolderID:this.userselect.UnitholderId,TxType:"Redemption"};console.log(e),this.orderservice.getorderinfolist(e).pipe(operators_1.first()).subscribe(function(e){if(console.log(e),o.orderredemptionlist=e,o.nolist=!1,o.orderredemptionlist.orderinfolist)for(var t=0;t<o.orderredemptionlist.orderinfolist.length;t++)"Initial"==o.orderredemptionlist.orderinfolist[t].OrderStatus&&"Redemption"==o.orderredemptionlist.orderinfolist[t].TxType&&(o.nolist=!0,console.log("nolist"))},function(e){console.log(e),o.message=e.error.messages,$("#message").modal({backdrop:"static",keyboard:!1,show:!0})})},e.prototype.createFormValidate=function(){this.formredemption=this.fb.group({amount:[null,[forms_1.Validators.required]],date:[null],type:["",[forms_1.Validators.required]],fund:["",[forms_1.Validators.required]]})},e.prototype.validateAllFormFields=function(o){var r=this;Object.keys(o.controls).forEach(function(e){var t=o.get(e);t instanceof forms_1.FormControl?t.markAsTouched({onlySelf:!0}):t instanceof forms_1.FormGroup&&r.validateAllFormFields(t)})},e.prototype.isFieldNotValid=function(e){return!this.formredemption.get(e).valid&&this.formredemption.get(e).touched},e.prototype.ValidatorDisplayCss=function(e){return{"has-danger":this.isFieldNotValid(e)}},e.prototype.numberOnly=function(e){var t=e.which?e.which:e.keyCode;return!(31<t&&(t<48||57<t))},e.prototype.notmorethan=function(){if(console.log(this.formredemption.controls.amount.value),this.formredemption.controls.amount.value){var e=this.formredemption.controls.amount.value;e=e.replace(",",""),e=parseFloat(e)}return"Amount"==this.Type?e>this.holdingbalanceselected.availablebalance.AvailableAmount?(console.log("false"),this.formredemption.controls.amount.setValue(this.holdingbalanceselected.availablebalance.AvailableAmount,{onlySelf:!0}),!1):(console.log("true"),!0):"Unit"==this.Type?e>this.holdingbalanceselected.availablebalance.AvailableUnit?(console.log("false"),this.formredemption.controls.amount.setValue(this.holdingbalanceselected.availablebalance.AvailableUnit,{onlySelf:!0}),!1):(console.log("true"),!0):(this.formredemption.controls.type.markAsTouched(),!1)},e.prototype.notfill=function(e){var t=e.which?e.which:e.keyCode;return""==this.Type?(this.formredemption.controls.type.markAsTouched(),!1):!(31<t&&(t<48||57<t)&&46!==t)},e.prototype.onChangeType=function(){if(console.log(this.formredemption.controls.type.value),this.Type=this.formredemption.controls.type.value,this.formredemption.controls.amount.value){var e=this.formredemption.controls.amount.value;if(e=e.replace(",",""),e=parseFloat(e),"Amount"==this.Type){var t=e.toFixed(2);if(this.formredemption.controls.fund.value)if(e>this.holdingbalanceselected.availablebalance.AvailableAmount)t=(t=parseFloat(this.holdingbalanceselected.availablebalance.AvailableAmount).toFixed(2)).toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),this.formredemption.controls.amount.setValue(t,{onlySelf:!0});else this.formredemption.controls.amount.setValue(t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),{onlySelf:!0});else this.formredemption.controls.amount.setValue(t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),{onlySelf:!0})}else if("Unit"==this.Type){t=e.toFixed(4);if(this.formredemption.controls.fund.value)if(e>this.holdingbalanceselected.availablebalance.AvailableUnit)(o=(t=parseFloat(this.holdingbalanceselected.availablebalance.AvailableUnit).toFixed(4)).toString().split("."))[0]=o[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),this.formredemption.controls.amount.setValue(o.join("."),{onlySelf:!0});else(o=t.toString().split("."))[0]=o[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),this.formredemption.controls.amount.setValue(o.join("."),{onlySelf:!0});else(o=t.toString().split("."))[0]=o[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),this.formredemption.controls.amount.setValue(o.join("."),{onlySelf:!0})}}else if("All"==this.Type&&this.formredemption.controls.fund.value){var o;if(this.holdingbalanceselected.availablebalance.AvailableUnit)(o=(t=parseFloat(this.holdingbalanceselected.availablebalance.AvailableUnit).toFixed(4)).toString().split("."))[0]=o[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),this.formredemption.controls.amount.setValue(o.join("."),{onlySelf:!0})}},e.prototype.tofix=function(e){if(console.log(e),"Amount"==this.Type)e&&(t=(t=e).replace(",",""),o=(o=parseFloat(t).toFixed(2)).toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),console.log(o),this.formredemption.controls.amount.setValue(o,{onlySelf:!0}));else if("Unit"==this.Type&&e){var t;t=(t=e).replace(",","");var o,r=(o=parseFloat(t).toFixed(4)).toString().split(".");r[0]=r[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),console.log(o),this.formredemption.controls.amount.setValue(r.join("."),{onlySelf:!0})}},e.prototype.onSubmited=function(){var t=this;if(this.loading=!0,console.log(this.formredemption),this.formredemption.controls.amount.valid&&this.formredemption.controls.type.valid&&this.formredemption.controls.fund.valid)if(this.isNotValid=!1,this.unitholderredemption.bankaccountlist[0]){var e;if(this.formredemption.controls.amount.value){var o=this.formredemption.controls.amount.value;o=o.replace(",",""),o=parseFloat(o)}this.formredemption.controls.date.value?(this.date=this.formredemption.controls.date.value.year+"-"+this.formredemption.controls.date.value.month+"-"+this.formredemption.controls.date.value.day,this.date=dateformat_1.boostrapdatepicker(this.date),e="Amount"==this.Type?{UnitHolderID:this.userselect.UnitholderId,FundID:this.formredemption.controls.fund.value.FundID,CounterFundID:0,TxType:"Redemption",OrderUnitType:"Amount",OrderUnit:0,OrderBankAccountID:this.banklist.BankAccountID,OrderAmount:o,PaymentMethod:"ATS",orderdate:this.date}:"Unit"==this.Type?{UnitHolderID:this.userselect.UnitholderId,FundID:this.formredemption.controls.fund.value.FundID,CounterFundID:0,TxType:"Redemption",OrderUnitType:"Unit",OrderUnit:o,OrderBankAccountID:this.banklist.BankAccountID,OrderAmount:0,PaymentMethod:"ATS",orderdate:this.date}:{UnitHolderID:this.userselect.UnitholderId,FundID:this.formredemption.controls.fund.value.FundID,CounterFundID:0,TxType:"Redemption",OrderUnitType:"All",OrderUnit:this.holdingbalanceselected.availablebalance.AvailableUnit,OrderBankAccountID:this.banklist.BankAccountID,OrderAmount:0,PaymentMethod:"ATS",orderdate:this.date}):e="Amount"==this.Type?{UnitHolderID:this.userselect.UnitholderId,FundID:this.formredemption.controls.fund.value.FundID,CounterFundID:0,TxType:"Redemption",OrderUnitType:"Amount",OrderUnit:0,OrderBankAccountID:this.banklist.BankAccountID,OrderAmount:o,PaymentMethod:"ATS",orderdate:null}:"Unit"==this.Type?{UnitHolderID:this.userselect.UnitholderId,FundID:this.formredemption.controls.fund.value.FundID,CounterFundID:0,TxType:"Redemption",OrderUnitType:"Unit",OrderUnit:o,OrderBankAccountID:this.banklist.BankAccountID,OrderAmount:0,PaymentMethod:"ATS",orderdate:null}:{UnitHolderID:this.userselect.UnitholderId,FundID:this.formredemption.controls.fund.value.FundID,CounterFundID:0,TxType:"Redemption",OrderUnitType:"All",OrderUnit:this.holdingbalanceselected.availablebalance.AvailableUnit,OrderBankAccountID:this.banklist.BankAccountID,OrderAmount:0,PaymentMethod:"ATS",orderdate:null},console.log(e),this.orderservice.submitorder(e).pipe(operators_1.first()).subscribe(function(e){console.log(e),t.resultsubmit=e,t.validateorderrmfltf(),t.loading=!1},function(e){console.log(e),t.loading=!1,t.message=e.error.messages,$("#message").modal({backdrop:"static",keyboard:!1,show:!0})})}else this.message="ติดต่อเจ้าหน้าที่การตลาด เบอร์ติดต่อ 02-286-3484 หรือ 02-679-2155 เพื่อดำเนินขอเปิดบัญชี ATS",this.loading=!1,setTimeout(function(){$("#message").modal({backdrop:"static",keyboard:!1,show:!0})},100);else this.isNotValid=!0,this.validateAllFormFields(this.formredemption),this.loading=!1},e.prototype.validateorderrmfltf=function(){var t=this;this.loading=!0,this.orderservice.validateorderrmfltf(this.resultsubmit.data).pipe(operators_1.first()).subscribe(function(e){console.log(e),t.resultvalidate=e,t.loading=!1,""!=t.resultvalidate.messages[0]?(console.log("not null"),t.message=t.resultvalidate.messages[0],setTimeout(function(){$("#warning-ltfrmf").modal({backdrop:"static",keyboard:!1,show:!0})},100)):t.checkpage("sell-step1")},function(e){console.log(e),t.message=e.error.messages,t.loading=!1,$("#message").modal({backdrop:"static",keyboard:!1,show:!0})})},e.prototype.confirmredemption=function(){var t=this;this.loading=!0,this.orderservice.confirmorder(this.resultsubmit.data).pipe(operators_1.first()).subscribe(function(e){console.log(e),t.checkpage("sell-step2"),t.loading=!1,t.message="ทำรายการสำเร็จ",$("#message").modal({backdrop:"static",keyboard:!1,show:!0})},function(e){console.log(e),t.message=e.error.messages,t.loading=!1,$("#message").modal({backdrop:"static",keyboard:!1,show:!0})})},e.prototype.reset=function(){console.log("reset"),this.Type="",this.holdingbalanceselected="",this.createFormValidate(),this.getselectlistfundlistandbankaccount()},e.prototype.modaldeleteorder=function(e){this.deletedOrder=e,console.log(this.deletedOrder),$("#delete").modal({backdrop:"static",keyboard:!1,show:!0})},e.prototype.deleteorder=function(){var t=this;this.loading=!0;var e={UnitHolderID:this.deletedOrder.UnitHolderID,OrderID:this.deletedOrder.OrderID};this.orderservice.cancelorder(e).pipe(operators_1.first()).subscribe(function(e){console.log(e),t.loading=!1,t.getorderinfolist(),$("#delete").modal("toggle"),t.message="ลบรายการสำเร็จ",$("#message").modal({backdrop:"static",keyboard:!1,show:!0})},function(e){console.log(e),$("#delete").modal("toggle"),t.message=e.error.messages,t.loading=!1,$("#message").modal({backdrop:"static",keyboard:!1,show:!0})})},e.prototype.print=function(){window.focus(),window.print()},e.prototype.resetdate=function(){this.formredemption.controls.date.reset()},e=__decorate([core_1.Component({selector:"app-sell",templateUrl:"./sell.component.html",styleUrls:["./sell.component.scss"]})],e)}();exports.SellComponent=SellComponent;