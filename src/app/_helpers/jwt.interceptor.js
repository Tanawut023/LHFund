"use strict";var __decorate=this&&this.__decorate||function(e,t,r,o){var n,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;0<=i;i--)(n=e[i])&&(s=(a<3?n(s):3<a?n(t,r,s):n(t,r))||s);return 3<a&&s&&Object.defineProperty(t,r,s),s};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),http_1=require("@angular/common/http"),rxjs_1=require("rxjs"),operators_1=require("rxjs/operators"),authentication_service_1=require("../service/authentication.service"),JwtInterceptor=function(){function e(e,t,r){this.router=e,this.injector=t,this.authservice=r,this.isRefreshingToken=!1,this.tokenSubject=new rxjs_1.BehaviorSubject(null),this.generateAuthHeaders=function(e){var t=JSON.parse(localStorage.getItem("currentUser"));return e.clone({setHeaders:{Authorization:"Bearer "+t.access_token,"Accept-Language":localStorage.getItem("lang")?localStorage.getItem("lang"):"en","Content-Type":"application/json"}})}}return e.prototype.handle401Error=function(t,r){var o=this;return t=this.generateAuthHeaders(t),this.isRefreshingToken?(this.isRefreshingToken=!1,this.tokenSubject.pipe(operators_1.filter(function(e){return null!=e}),operators_1.take(1),operators_1.switchMap(function(e){return r.handle(t)}))):(this.isRefreshingToken=!0,this.tokenSubject.next(null),console.log("here"),this.authservice.refreshToken().pipe(operators_1.switchMap(function(e){if(e)return console.log("sdsd"),console.log(e),o.tokenSubject.next(e.access_token),localStorage.setItem("currentUser",JSON.stringify(e)),r.handle(t)}),operators_1.catchError(function(e){return console.log(e),o.authservice.logout()}),operators_1.finalize(function(){o.isRefreshingToken=!1})))},e.prototype.intercept=function(e,t){var r=this;e.clone();this.authservice=this.injector.get(authentication_service_1.AuthenticationService);var o=JSON.parse(localStorage.getItem("currentUser"));if(o&&o.access_token)return e=this.generateAuthHeaders(e),t.handle(e).pipe(operators_1.catchError(function(e){if(!(e instanceof http_1.HttpErrorResponse))return rxjs_1.throwError(e);401===e.status&&r.router.navigate(["/login"],{queryParams:{returnUrl:r.router.url}})}));var n=new http_1.HttpHeaders({"Accept-Language":localStorage.getItem("lang")?localStorage.getItem("lang"):"en"});return t.handle(e.clone({headers:n}))},e=__decorate([core_1.Injectable()],e)}();exports.JwtInterceptor=JwtInterceptor;